<div ng-controller="LevelsController" id="levels">

    <form class="form-horizontal" role="form" ng-show="levelsContext.show">


        <div class="row">
            <div class="col-md-6" ng-if="views.length > 0">
                <h3>Vues</h3>
                <ul>
                    <li ng-repeat="v in views">
                        <button type="button" class="btn btn-xs btn-link" ng-click="selectView(v)">
                            {{v.trollId}} ({{v.date|date:'dd/MM/yyyy à HH:mm:ss'}})
                        </button>

                        <button type="button" class="btn btn-xs btn-danger" ng-click="deleteView(v)"
                                title="Supprimer" ng-disabled="!v['_id']['$id']">
                            <span class="glyphicon glyphicon-trash"></span>
                        </button>
                    </li>
                </ul>
            </div>
            <div class="col-md-6">

                <div class="alert alert-warning">
                    L'utilisation des scripts publics (SP) est soumise à quotas, évitez de faire trop d'appels.
                </div>

                <!--<div class="alert alert-info">-->
                    <!--Vous pouvez entrer ici votre identifiant de troll ainsi qu'un mot de passe spécifique généré via-->
                    <!--MountyHall. Pour cela allez dans "Option" &gt; "Options Trõll" &gt; "Générer/Révoquer un code-->
                    <!--d'accès spécifique pour les applications externes".-->
                <!--</div>-->

                <div class="form-group">

                    <div class="col-md-3">
                        <input type="number" ng-model="levelContext.spTrollId" class="form-control"
                               placeholder="Numéro de Trõll"/>
                    </div>
                    <div class="col-md-4">
                        <input type="text" ng-model="levelContext.spTrollPassword" class="form-control"
                               placeholder="Mot de passe spécifique"/>
                    </div>

                    <button type="button" class="btn btn-sm btn-success" ng-click="downloadViewFromSp()"
                            ng-disabled="!levelContext.spTrollId || !levelContext.spTrollPassword">
                        <span class="glyphicon glyphicon-import"></span> Télécharger la vue depuis MountyHall
                    </button>
                </div>
            </div>
        </div>

        <div class="row" ng-if="selectedView">
            <h2>Monstres dans la vue du Trõll n°{{selectedView.trollId}} du  {{selectedView.date|date:'dd MMMM yyyy à HH:mm:ss'}}</h2>

            <div class="alert alert-info">
                Vue centrée en <b>X={{selectedView.origin.x}} | Y={{selectedView.origin.y}} | N={{selectedView.origin.n}}</b>
                avec une portée de <b>{{selectedView.scope ? selectedView.scope : selectedView.distance}}</b> cavernes.
                <b>{{levelContext.filteredMonstersCount}}</b> monstres affichés sur <b>{{selectedView.monsters.length}}</b>.
            </div>

            <div class="form-group">

                <label for="maxDistance" class="col-sm-1 control-label">Distance max.</label>
                <div class="col-xs-1">
                    <input type="number" id="maxDistance" ng-model="levelContext.maxDistance" class="carac" min="0"/>
                </div>

                <label for="includeGowap" class="col-sm-1 control-label">Gowap ?</label>
                <div class="col-xs-1">
                    <input type="checkbox" id="includeGowap" ng-model="levelContext.includeGowap"/>
                </div>

                <label for="includeZombi" class="col-sm-1 control-label">Zombi ?</label>
                <div class="col-xs-1">
                    <input type="checkbox" id="includeZombi" ng-model="levelContext.includeZombi"/>
                </div>

                <label for="minLevel" class="col-sm-1 control-label">Nival min.</label>
                <div class="col-xs-1">
                    <input type="number" id="minLevel" ng-model="levelContext.minLevel" class="carac" min="0" max="99"
                           ng-change="minLevelChanged()"/>
                </div>

                <label for="maxLevel" class="col-sm-1 control-label">Nival max.</label>
                <div class="col-xs-1">
                    <input type="number" id="maxLevel" ng-model="levelContext.maxLevel" class="carac" min="0" max="99"
                           ng-change="maxLevelChanged()"/>
                </div>

            </div>

            <script type="text/ng-template" id="aroundMonster.html">
                <div class="modal-header">
                    <span class="around-monster-title">Aux alentours de : {{targetMonster.name}} - N°{{targetMonster.id}}</span>
                    <span class="around-monster-position">X={{targetMonster.posX}}|Y={{targetMonster.posY}}|N={{targetMonster.posN}}</span>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered table-condensed table-hover around-monster">
                        <tbody>
                        <tr>
                            <td></td>
                            <td ng-repeat="x in xRange">{{x}}</td>
                            <td></td>
                        </tr>
                        <tr ng-repeat="y in yRange">
                            <td>{{y}}</td>
                            <td ng-repeat="(x, subSubGrid) in aroundMonstersGrid[y]"
                                class="{{((x==targetMonster.posX && y==targetMonster.posY) ? 'center':((x<limits.lowerX || x>limits.upperX || y<limits.lowerY || y>limits.upperY) ? 'out-of-scope':''))}}">
                                <ul>
                                    <li ng-repeat="(n, monsters) in subSubGrid" >
                                        <a class="{{(x==targetMonster.posX && y==targetMonster.posY && n==targetMonster.posN) ? 'target-level':''}}"
                                           href="#" title="{{monsters|monstersList}}">{{n}}:{{monsters.length}}</a>
                                    </li>
                                </ul>
                            </td>
                            <td>{{y}}</td>
                        </tr>
                        <tr>
                            <td></td>
                            <td ng-repeat="x in xRange">{{x}}</td>
                            <td></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" ng-click="closeAroundMonster()">OK</button>
                </div>
            </script>

            <table class="table table-striped table-hover table-condensed">
                <thead>
                <tr>
                    <td ng-if="selectedView.origin">Distance</td>
                    <td>Id</td>
                    <td>Nom</td>
                    <td>Position</td>
                    <td>Nom de base</td>
                    <td>Template</td>
                    <td>Âge</td>
                    <td>Nival</td>
                </tr>
                </thead>
                <tbody>
                <tr ng-repeat="m in selectedView.monsters|filterMonster:levelContext|orderBy:'distance'" class="{{m.nival >= 50 ? 'best':''}}">
                    <td ng-if="selectedView.origin">{{m.distance}}</td>
                    <td>{{m.id}}</td>
                    <td ng-click="viewAroundMonster(m)">{{m.name}}</td>
                    <td>X={{m.posX}}|Y={{m.posY}}|N={{m.posN}}</td>
                    <td><abbr title="{{m.family}}">{{m.baseName}}</abbr> ({{m.baseNival}})</td>
                    <td>{{m.template|orDash}} <span ng-if="m.template">({{m.templateBonus|addSign}})</span></td>
                    <td>{{m.age}} ({{m.ageBonus|addSign}})</td>
                    <td>{{m.nival|orDash}}</td>
                </tr>
                <tr ng-if="levelContext.filteredMonstersCount == 0" class="empty"><td colspan="8">Aucun monstre ne correspond à vos filtres</td></tr>
                </tbody>
            </table>
            <!--<ul>-->
                <!--<li ng-repeat="m in selectedView.monsters">{{m}}</li>-->
            <!--</ul>-->
        </div>

    </form>

</div>
